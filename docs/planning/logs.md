## Progress Log (Append-Only)
- 2026-02-10: Initial strategy drafted with M0-M7 milestone structure and test-first approach.
- 2026-02-10: Integrated Review 1 feedback (`F-001` to `F-016`). Switched to single-package early architecture, added CSM sketch, split sync/async parse API, defined strict/lenient behavior, moved Playwright to M2, moved collision audits to M3, added timewise plan, added distribution/patch strategy details, and updated conformance metadata scaling strategy.
- 2026-02-10: Integrated Review 2 feedback (`F-017` to `F-024`). Removed encoding artifacts from CSM events, clarified chord modeling, added explicit `ticksPerQuarter`, added `EffectiveAttributes`/spanner/diagnostic type sketches, clarified `.mxl` implementation timing, and pinned Vitest as the M0 test runner.
- 2026-02-10: Began M0 implementation. Added single-package TypeScript scaffold, ESLint/Prettier/Vitest configs, CI workflow, initial public API placeholders, conformance metadata schema, fixture loader, and baseline unit/integration/conformance tests.
- 2026-02-10: Completed M0 validation. `npm run lint`, `npm run typecheck`, `npm run build`, `npm run test`, `npm run test:unit`, `npm run test:integration`, and `npm run test:conformance` all pass locally.
- 2026-02-10: Completed M1 parser baseline. Added `saxes` XML AST with location/path tracking, implemented `score-partwise` AST-to-CSM parsing (parts/measures/attributes/voices/notes/rests/chords, backup/forward normalization), strict/lenient diagnostics, score-timewise detection, ADR-0001 + parser/diagnostics/CSM docs, and expanded integration/unit coverage.
- 2026-02-10: Completed M2 rendering baseline implementation. Added `src/vexflow/render.ts` mapper for clef/key/time + notes/rests/barlines, wired `renderToSVGPages` and `renderToElement` through public API, introduced `tests/svg/render-structure.test.ts`, and added Playwright smoke harness (`playwright.config.ts`, `tests/visual/render-visual.spec.ts`) with CI SVG gate updates.
- 2026-02-10: Completed M2 documentation/state sync. Added `docs/rendering-pipeline.md`, updated README and VexFlow adapter docs, and validated browser render smoke via Playwright MCP (SVG present with expected stave/note/barline structure and captured screenshot artifact).
- 2026-02-10: Applied design/commenting conformance pass across parser/renderer/public API/testkit/core model files. Added detailed API/function/type comments and renderer config hardening for local Playwright executable resolution across architecture variants.
- 2026-02-10: Refactored parser into cohesive modules (`parse-context`, `xml-utils`, `parse-header`, `parse-note`, `parse-timing`, `parse-constants`) and reduced `parse.ts` to orchestration + part/measure control flow while preserving test behavior.
- 2026-02-10: Refactored VexFlow renderer into cohesive modules (`render-types`, `render-dom`, `render-note-mapper`) and reduced `render.ts` to orchestration/layout flow while preserving M2 rendering behavior and test results.
- 2026-02-10: Started M3 implementation by adding score-timewise normalization (`src/parser/parse-timewise.ts`) and integrating root-level normalization in parser orchestration.
- 2026-02-10: Added M3 normalization coverage in integration tests (`tests/integration/public-api.test.ts`, `tests/integration/parser-csm.test.ts`) covering multi-part/missing-part-measure timewise cases.
- 2026-02-10: Added M3 `.mxl` baseline extraction path (`src/parser/mxl.ts`) with ZIP central-directory parsing, `META-INF/container.xml` rootfile resolution, and diagnostic-backed fallback score lookup.
- 2026-02-10: Integrated `.mxl` extraction into `parseMusicXMLAsync` and added async integration coverage for container resolution, fallback behavior, strict-mode escalation, and invalid archive diagnostics.
- 2026-02-10: Added M3 timing-model consistency diagnostics for stream-cursor anomalies (`BACKUP_BEFORE_MEASURE_START`, `MEASURE_CURSOR_OVERFLOW`) in measure parsing.
- 2026-02-10: Added deterministic property-style integration tests for randomized two-voice `backup`/`forward` timing conservation and expanded parser invariant coverage.
- 2026-02-10: Added first headless collision-audit helpers (`src/testkit/svg-collision.ts`) with SVG bounds extraction, overlap detection, and dedicated `tests/svg/collision-audit.test.ts` coverage (synthetic + rendered fixtures).
- 2026-02-10: Expanded `.mxl` parser integration coverage for container/rootfile edge cases (missing referenced score path, malformed `container.xml` fallback, unsupported compression method, truncated archive handling).
- 2026-02-10: Added conformance collision-audit metadata/report workflow (`collision_audit` schema + loader validation + `runConformanceCollisionAudit`) with dedicated tests and smoke fixture wiring.
- 2026-02-10: Added initial conformance execution test path (`tests/conformance/execution.test.ts`) that runs active fixtures end-to-end through parse/render and applies collision-audit pass/fail checks from metadata.
- 2026-02-10: Refactored conformance execution into reusable testkit module (`src/testkit/conformance-execution.ts`) with aggregate result types and markdown/json report formatting helpers.
- 2026-02-10: Added report artifact emission path (`npm run test:conformance:report`) writing `artifacts/conformance/conformance-report.{json,md}`.
- 2026-02-10: Added staged `timewise` and `rhythm` conformance fixtures (`minimal-timewise`, `backup-forward-two-voices`) and expanded conformance execution tests to cover all active fixtures.
- 2026-02-10: Added M3 timing-model design note (`docs/timing-model.md`) documenting cursor invariants, backup/forward/chord normalization semantics, and diagnostic mappings.
- 2026-02-10: Added expected-vs-observed conformance execution semantics and introduced first active expected-fail fixture (`parser-malformed-xml`) to enforce expected-fail gating behavior.
- 2026-02-10: Added AI acceleration context files (`ai-state.md`, `docs/musicxml-tips.md`, `docs/vexflow-tips.md`, `docs/playwright-tips.md`) for faster dependency/tooling rehydration.
- 2026-02-10: Added conformance report diagnostic histograms (parse/render code + severity aggregates) and markdown rendering sections for faster failure triage.
- 2026-02-10: Added conformance report category rollups keyed by fixture category, including per-category pass/fail and diagnostic histogram aggregates.
- 2026-02-10: Added Playwright visual sentinel specs (`tests/visual/conformance-sentinels.spec.ts`) covering active `smoke`, `timewise`, and `rhythm` pass fixtures.
- 2026-02-10: Re-ran Playwright visual suite under elevated permissions; `npm run test:visual` passed for all sentinel + smoke visual tests.
- 2026-02-10: Added concrete expected-fail conformance fixtures for unsupported root handling (`parser-unsupported-root-opus`) and malformed `.mxl` archive handling (`mxl-invalid-container`) with execution/report assertions.
- 2026-02-10: Added fixture-level conformance `parse_mode` support (`strict`/`lenient`) and notation strict-vs-lenient fixture pair (`notation-invalid-pitch-step-*`) to validate nuanced warning-vs-error expected behavior.
- 2026-02-10: Added Playwright visual snapshot assertions and generated baseline images for smoke + conformance sentinel suites via `npm run test:visual:update`.
- 2026-02-10: Completed M3 milestone and advanced next-step focus to M4 notation/direction implementation scope.
- 2026-02-10: Implemented M4 parser/model notation flow: direction dynamics/wedges, note slurs, and post-parse spanner linking for ties/slurs/wedges with strict-mode diagnostic escalation coverage.
- 2026-02-10: Implemented M4 renderer notation flow: articulation mapping, direction text placement, and tie/slur/wedge drawing; corrected VexFlow API integration (`Curve` options, `StaveHairpin` note keys/options) and stabilized render diagnostics.
- 2026-02-10: Expanded M4 tests: parser continuity assertions for tie/slur/wedge, note-mapper articulation unit tests, SVG structure assertions for notation baseline, conformance assertions for `notation-m4-baseline`, and visual sentinel coverage/snapshots for notation baseline.
- 2026-02-10: Completed M4 docs/state sync: updated README milestone/status, refreshed rendering/CSM/diagnostic docs, and added `docs/notation-support-matrix.md` plus `plan.md`/`todo.md`/`ai-state.md` milestone state updates.
- 2026-02-10: Started M5 renderer layout baseline by replacing single-part rendering with multi-part/multi-staff system layout, per-staff note routing, and connector drawing (`singleLeft`, `brace`, `bracket`).
- 2026-02-10: Added M5 tests for staff routing and layout structure across unit/integration/svg layers and preserved passing deterministic headless suite gates.
- 2026-02-10: Added active M5 conformance layout fixture (`layout-m5-multipart-baseline`) and expanded Playwright visual sentinels with a new snapshot baseline for multi-part/multi-staff layout output.
- 2026-02-10: Added M5 lyric/harmony parser support (`<harmony>`, `<lyric>`) and renderer text attachment passes with deterministic headless text-width estimation.
- 2026-02-10: Extended part-list parsing to include MusicXML `part-group` semantics, surfaced via `PartDefinition.groupPath`, and mapped group symbols to connector styles during rendering.
- 2026-02-10: Added text-aware SVG collision bounds (`<text>`) and promoted text overlap checks via new conformance fixture `text-m5-lyrics-harmony-baseline`.
- 2026-02-10: Completed M5 documentation gates with `docs/layout-heuristics.md` and `docs/modularization-decision.md`; milestone state advanced to completed.
- 2026-02-10: Implemented M6 parser/model features for grace/cue note flags, ornament tokens, tuplet endpoint/ratio metadata, and repeat/ending barline metadata aggregation.
- 2026-02-10: Implemented M6 renderer features for grace-note attachment, cue-size rendering, ornament modifiers, tuplet draw pass, and repeat/ending stave semantics.
- 2026-02-10: Added M6 conformance fixture (`advanced-m6-notation-baseline`) and expanded unit/integration/svg/conformance test coverage for advanced notation constructs.
- 2026-02-10: Added `docs/advanced-notation-policy.md` and refreshed notation/rendering/tips/README/AI state docs to reflect M6 support and fallback boundaries.
- 2026-02-10: Local/MCP Playwright browser launches were blocked by host MachPort/session constraints in this execution context; headless test gates passed and visual baseline updates remain environment-dependent.
- 2026-02-10: Added milestone-linked demo pipeline with tracked MusicXML demos (`happy-birthday`, `jingle-bells`), static build/serve scripts (`npm run demos:build`, `npm run demos:serve`), integration coverage (`tests/integration/demos.test.ts`), and README/AGENTS usage instructions.
- 2026-02-10: Replaced hand-authored demos with canonical LilyPond web fixtures (`01c`, `71g`), added `demos/lilypond/manifest.json` plus generated `demos/site/lilypond-roadmap.html`, and updated plan/todo/docs to make full LilyPond demo parity an explicit M7 end goal.
- 2026-02-10: Started M7 planning formalization; added `docs/m7-comprehensiveness-quality-plan.md`, split M7 into tracks M7A-M7D (comprehensiveness, quality rubric, layered eval framework, VexFlow upstream/release hardening), and updated M7 gates/checklists in plan/todo/ai-state.
- 2026-02-10: Implemented M7A corpus baseline: added LilyPond collated-suite sync script (`npm run corpus:lilypond:sync`), generated canonical corpus manifest (`fixtures/corpus/lilypond-collated-v2.25.json` with 30 categories / 156 fixtures), expanded seeded demos to 8 canonical fixtures, and refactored demo build pipeline + integration tests to validate roadmap seed/corpus consistency.
- 2026-02-10: Promoted M7A first conformance tranche by importing 8 seeded LilyPond fixtures into `fixtures/conformance/lilypond/` as active expected-pass cases and verified the expanded conformance workflow/report path remains green.
- 2026-02-10: Promoted M7A second conformance tranche by importing 21 additional LilyPond fixtures as active expected-pass cases, expanded conformance assertions for LilyPond category rollups, and kept full test + conformance report pipelines green.
- 2026-02-10: Added reusable `npm run corpus:lilypond:import` tooling to promote future LilyPond case batches into conformance fixtures from case IDs/source names with deterministic metadata generation.
- 2026-02-10: Fixed grace-note beaming regression (`B-002`) by guarding VexFlow `GraceNoteGroup.beamNotes()` and degrading to unbeamed grace notes with warning diagnostics; promoted `lilypond-24a-gracenotes` to active expected-pass coverage.
- 2026-02-10: Added `npm run conformance:lilypond:promote` bulk pipeline, imported all remaining LilyPond collated-suite fixtures, removed duplicate legacy seed IDs, and reached full corpus parity in conformance metadata (156/156 imported and active).
- 2026-02-10: Added representative real-world corpus manifest + importer (`npm run conformance:realworld:import`) and activated first 5 real-world fixtures (OpenScore Lieder + music21 corpus samples) with provenance/license metadata in conformance sidecars.
- 2026-02-10: Expanded M7A real-world coverage to 7 active fixtures by adding a lead-sheet sample (`realworld-music21-berlin-alexanders-ragtime`) and a large orchestral/choral excerpt (`realworld-music21-bach-bwv248-42-4`), added deterministic bucket-coverage integration gates (`tests/integration/realworld-corpus.test.ts`), and revalidated full test + conformance-report pipelines.
- 2026-02-10: Revalidated browser visual gates after M7A breadth expansion using repo-local Playwright binaries (`PLAYWRIGHT_BROWSERS_PATH=/Users/mo/git/musicxml/.playwright npm run test:visual -- --workers=4`), confirming all sentinel visual specs remain green.
- 2026-02-10: Added long-form stress fixture `realworld-music21-beethoven-op133-longform` to the real-world corpus/conformance set (now 8 active real-world fixtures; 176 active conformance fixtures total), increased conformance execution test timeout to 15s for expanded corpus runtime, and revalidated all headless + visual + demo-build gates.
- 2026-02-10: Reorganized planning artifacts under `/Users/mo/git/musicxml/docs/planning/`; split milestone docs into per-milestone files (`milestone-0.completed.md` .. `milestone-7D.md`), introduced `status.md` + `logs.md` ownership model, moved active/closed backlog into `todo.md` and `todo.completed.md`, and relocated feedback history to `/Users/mo/git/musicxml/docs/planning/feedback.md`.
- 2026-02-10: Completed M7A closeout by formalizing real-world complexity metadata (`complexity_level`, `part_count_hint`, `long_form`) with deterministic breadth gates, triaging `lilypond-23c-tuplet-display-nonstandard` as explicit malformed-source expected-fail policy, adding M7A conformance-threshold assertions (expected-pass `>=97%`, unexpected failures `<=1%`, LilyPond category floors `>=90%`), and promoting M7A status to completed in planning docs.
- 2026-02-10: Enforced milestone completion naming convention by renaming `docs/planning/milestone-7A.md` to `docs/planning/milestone-7A.completed.md`, updating all cross-doc references, and adding explicit completion-rename policy in `AGENTS.md` and `docs/planning/README.md`.
- 2026-02-11: Completed M7B by integrating deterministic quality rubric scoring (`Q1..Q7`) into conformance execution/reporting (`qualitySummary` + per-fixture quality payload), calibrating collision/layout proxies to avoid false catastrophic flags, and enforcing M7B gates (expected-pass weighted mean `>=4.2`, zero expected-pass catastrophic fixtures, zero expected-pass critical collisions) in `tests/conformance/execution.test.ts`; validated with `npm run lint`, `npm run typecheck`, `npm run test:conformance`, `npm run test`, and `npm run test:conformance:report`.
- 2026-02-11: Completed M7C by adding layered evaluation infrastructure: split/gate configs (`fixtures/evaluation/splits.json`, `fixtures/evaluation/gates.json`), deterministic split scoring utilities (`src/testkit/evaluation.ts` + `tests/unit/evaluation.test.ts`), layered runner command (`npm run eval:run`) with evaluation report artifacts (`artifacts/evaluation/evaluation-report.{json,md}`), perceptual diff output support, and runbook/prompt-schema governance docs.
- 2026-02-11: Completed M7D by adding VexFlow gap lifecycle tooling: registry (`fixtures/vexflow/gap-registry.json`), validator (`src/testkit/vexflow-gap-registry.ts`), enforcement tests (`tests/integration/vexflow-gap-registry.test.ts`), check/brief commands (`npm run vexflow:gaps:check`, `npm run vexflow:gaps:brief`), upstream brief artifacts, sync log, and release-hardening checklist.
- 2026-02-11: Closed milestone naming updates for M7 tracks by renaming planning docs to completed variants (`milestone-7.completed.md`, `milestone-7C.completed.md`, `milestone-7D.completed.md`) and updating cross-references in status/index/README/ai-state.
- 2026-02-11: Revalidated M7C/M7D completion gates after planning/doc restructuring and latest status format updates; `npm run lint`, `npm run typecheck`, `npm run test:unit`, `npm run test:integration`, `npm run test:conformance`, `npm run test`, `npm run vexflow:gaps:check`, `npm run vexflow:gaps:brief`, `npm run eval:run`, and `PLAYWRIGHT_BROWSERS_PATH=/Users/mo/git/musicxml/.playwright npm run test:visual -- --workers=4` all pass.
- 2026-02-11: Clarified LilyPond roadmap semantics after coverage confusion: split roadmap table into `Conformance Status` vs `Demo Status`, documented that `demos/lilypond/manifest.json` `categoryStatus` tracks demo seeding only, rebuilt demos, and revalidated integration tests.
- 2026-02-11: Expanded demo generation to cover every active LilyPond conformance fixture (156 case pages) plus selected complex real-world fixtures (6 pages), added expected-fail demo-page handling for malformed fixtures, and updated demo docs/index navigation to split featured seed demos vs full-suite coverage.
- 2026-02-11: Fixed two high-signal rendering defects with generalized renderer updates: switched measure formatting to stave-aware note-area layout (`Formatter.formatToStave`) to prevent barline bleed in `lilypond-01a-pitches-pitches`, and added automatic per-voice beam generation (`Beam.generateBeams`) to restore beaming in `realworld-music21-bach-bwv1-6`.
- 2026-02-11: Added reusable notation-geometry tooling (`src/testkit/notation-geometry.ts`) for beam presence and notehead/barline intrusion audits, integrated intrusion metrics into conformance quality scoring (`Q6`), and added dedicated regression tests (`tests/integration/render-quality-regressions.test.ts`, `tests/unit/notation-geometry.test.ts`).
- 2026-02-11: Expanded visual sentinel coverage definitions to include `lilypond-01a-pitches-pitches` and `realworld-music21-bach-bwv1-6`; local Playwright launch remains blocked in this sandbox by MachPort permission errors (`bootstrap_check_in ... Permission denied (1100)`), so visual assertions could not be rebaselined here.
- 2026-02-11: Added browser-free visual portability tooling: `src/testkit/headless-visual.ts`, `scripts/run-headless-visual-regression.mjs`, `scripts/inspect-score-headless.mjs`, and `npm run inspect:score` to support fast one-score SVG/PNG/geometry inspection without Playwright; updated AGENTS/README/tips/ai-state docs to make this the default rapid triage path on headless hosts.
- 2026-02-11: Opened Milestone 8 planning (`docs/planning/milestone-8.md`) for golden-driven visual quality execution: LilyPond reference image mapping, deterministic geometry/presence/justification rule expansion, headless golden diffing, and wave-based fixture remediation across the full demo/conformance set.
- 2026-02-11: Implemented M8A golden-reference sync pipeline (`scripts/sync-golden-references.mjs`, `npm run golden:sync`) with full active LilyPond fixture coverage (156 mappings), cached PNG artifacts under `fixtures/golden/lilypond-v2.24/`, and generated manifest metadata (`fixtures/golden/manifest.json`) including checksum fields and explicit `referenceKind` tags for v2.24 primary vs v2.25 fallback references.
- 2026-02-11: Implemented M8B first-quality remediation for `lilypond-01a-pitches-pitches` by adding generalized first-column width compensation in `src/vexflow/render.ts`, eliminating opening-measure note compression, and extending notation geometry tooling with deterministic measure-spacing summaries (`summarizeMeasureSpacingByBarlines`) plus updated regression coverage and `inspect:score` reporting.
- 2026-02-11: Opened Milestone 9 style-fidelity program (`docs/planning/milestone-9.md`) with source-linked engraving guidance (LilyPond docs, SMuFL engraving defaults, MOLA guidelines, Behind Bars preview), explicit style dimensions (`S1..S6`), proof-point fixtures, and burndown-based execution tracks parallel to M8.
- 2026-02-11: Rebaselined and revalidated headless visual output for `lilypond-01a-pitches-pitches` after spacing fixes (`npm run test:visual:headless:update -- --fixtures=lilypond-01a-pitches-pitches` and `npm run test:visual:headless -- --fixtures=lilypond-01a-pitches-pitches` both pass).
- 2026-02-11: Implemented M8C initial golden runner (`npm run test:golden`, `scripts/run-golden-comparison.mjs`) with direct fixture-to-reference comparisons, crop-aware excerpt support, blocking vs advisory fixture policy, and triage artifacts under `artifacts/golden-comparison/`.
- 2026-02-11: Added first real-world proof-point manifest (`fixtures/evaluation/golden-proofpoints.json`) and executed `realworld-music21-bach-bwv1-6-8bars` against `fixtures/images/bwv-1.6-8bars.png`; run currently fails as advisory (expected) and serves as baseline evidence for missing pagination/title/part-label parity.
- 2026-02-11: Opened Milestone 10 (`docs/planning/milestone-10.md`) to deliver first-class pagination API (paginated default, horizontal continuous fallback), system/page layout engine, and publishing metadata elements (title, instrument labels, page numbers) required for high-fidelity PDF/image comparisons.
- 2026-02-11: Continued M10 execution by hardening page output determinism: injected explicit SVG page background rects (`mx-page-background`) to remove transparent/black screenshot artifacts, added integration assertions for page-background presence, and revalidated renderer quality regression suites.
- 2026-02-11: Re-ran Bach proof-point inspection/golden comparison after M10/background updates; mismatch improved to `0.129259` with `ssim=0.290393` (still advisory fail), and planning/risk state was updated to track remaining M10C/M10D fidelity work.
- 2026-02-11: Added paginated-layout integration coverage in `tests/integration/public-api.test.ts` to lock header/title/page-number/label option behavior and multi-page output under deterministic small-page settings.
- 2026-02-11: Fixed paginated spanner diagnostics by making spanner evaluation page-window-aware; off-page anchors no longer trigger false `SPANNER_ANCHOR_NOT_RENDERED` warnings while same-window anchor misses remain actionable.
- 2026-02-11: Added metadata fallback parsing from centered MusicXML `<credit><credit-words>` entries so real-world scores without explicit `<work-title>` still surface titles/page numbers in paginated output; parser fallback/precedence tests were added.
- 2026-02-11: Added parser + renderer support for MusicXML `<print new-system/new-page>` directives and corresponding integration tests for forced system/page break behavior.
- 2026-02-11: Revalidated Bach proof-point after print-break/title/spanner updates; render diagnostics are clean and pagination reflects source breaks, but visual parity remains advisory-fail (`mismatchRatio=0.129628`, `ssim=0.288110`) pending M10D spacing/geometry tuning.
- 2026-02-11: Added deterministic system-window auto-crop support for golden proof-points (`autoCropActual.systems`) via `deriveSystemCropRegion` in notation geometry tooling, switched the Bach proof-point config to use it, and re-ran proof-point validation (`mismatchRatio=0.214865`, `ssim=0.189070`, advisory fail) to establish a more reproducible M10D baseline.
- 2026-02-11: Added parser/model support for MusicXML `measure@width` hints (`sourceWidthTenths`) plus renderer weighted system-column sizing from source hints (median across parts), with new parser/render integration tests; Bach proof-point rerun remains advisory fail (`mismatchRatio=0.214798`, `ssim=0.192180`) but spacing drift improved (`first/median gap ratio 1.173 -> 1.1411`).
- 2026-02-11: Added parser support for defaults `system-layout/system-margins` and applied those margins in paginated content-width planning; Bach proof-point improved again (`mismatchRatio=0.203193`, advisory fail). Golden runner now emits a structural mismatch metric alongside raw mismatch/SSIM for better M10D triage.
- 2026-02-11: Added parser/model coverage for note-level source geometry/stem intent (`sourceDefaultXTenths` + `stemDirection`), mapped explicit MusicXML stem direction into VexFlow note creation, and enabled beam generation with maintained authored stem directions; added deterministic parser + unit + integration regression tests.
- 2026-02-11: Added parser/model support for authored MusicXML beam tokens (`<beam number>begin/continue/end</beam>`) and renderer source-beam grouping preference (level-1 beam groups) before auto-beam fallback; added deterministic regression coverage and revalidated Bach proof-point metrics.
- 2026-02-11: Added optional centroid-based alignment to headless comparison core (`comparePngBuffers` options: `alignByInkCentroid`, `maxAlignmentShift`, `alignmentAxis`, `alignmentInkThreshold`) and unit coverage demonstrating lower mismatch for translated-but-equivalent images.
- 2026-02-11: Wired golden proof-point normalization to alignment controls, added alignment telemetry to golden reports (`alignmentShiftX`, `alignmentShiftY`), and constrained Bach proof-point alignment to horizontal-only registration (`alignmentAxis: "x"`); latest advisory run remains below target (`mismatchRatio=0.201615`, `structuralMismatchRatio=0.638949`, `ssim=0.170150`).
- 2026-02-11: Fixed beaming regression where flags remained visible on beamed notes by preparing beam groups before `voice.draw()` and drawing prepared beams afterward; added deterministic quality/eval coverage (`flagBeamOverlapCount` metrics, conformance summary fields, and expected-pass gate `expectedPassFlagBeamOverlapCount === 0`), then revalidated with `npm run lint`, `npm run typecheck`, targeted regression/conformance suites, and `npm run test:golden -- --proofpoints-only --fixtures=realworld-music21-bach-bwv1-6-8bars` (`flagCount=0`, `flagBeamOverlapCount=0`).
- 2026-02-11: Added adaptive inter-part spacing in `src/vexflow/render.ts` using adjacent-part complexity heuristics (`estimatePartComplexity`, `resolveInterPartGap`) so dense neighboring parts receive larger vertical gaps; added integration coverage in `tests/integration/public-api.test.ts`.
- 2026-02-11: Hardened part-label layout under source system margins by constraining wrap width to the true left-of-notation lane and keeping notation content width intact; existing `respects defaults system margins` and `keeps long part labels inside page bounds` tests remain green.
- 2026-02-11: Improved slur side/anchor routing in `src/vexflow/render-notations.ts` by selecting slur side from explicit placement or endpoint-skew minimization and computing diagnostics with side-aware anchors aligned to curve rendering.
- 2026-02-11: Expanded headless slur-anomaly detection in `src/testkit/notation-geometry.ts` to parse relative cubic path commands (`c`) in addition to absolute (`C`), and updated unit regression coverage.
- 2026-02-11: Added regression assertion for `realworld-music21-bach-bwv1-6` first-measure spacing stability in `tests/integration/render-quality-regressions.test.ts` (first/median spacing ratio guard > 0.85).
- 2026-02-11: Revalidated with `npm run lint`, `npm run typecheck`, `npm run test -- tests/unit/notation-geometry.test.ts`, `npm run test -- tests/integration/public-api.test.ts`, `npm run test -- tests/integration/render-quality-regressions.test.ts`, and refreshed proof-point inspections (`proof-bwv1-6-latest`, `proof-op133-latest`, `proof-op18-latest`).
- 2026-02-11: Fixed multi-staff clef regression for real-world fixtures by merging parser clef updates per staff (`applyAttributeUpdate`) instead of replacing full clef arrays, adding source-order fallback for unnumbered multi-clef groups, and preventing renderer cross-staff clef leakage; added parser integration regression coverage for partial-clef updates.
- 2026-02-11: Revalidated fixture set after clef fix with headless inspection: `realworld-music21-schumann-clara-polonaise-op1n1` and `realworld-music21-mozart-k545-exposition` no longer show prior staff-clef swaps; `realworld-music21-bach-bwv1-6` remains beam/flag clean (`flags=0`, `flagBeamOverlaps=0`).
- 2026-02-11: Hardened demo page overflow behavior by forcing `overflow-x: hidden` in generated demo HTML and rebuilding demos.
- 2026-02-11: Added M11 planning doc (`docs/planning/milestone-11.md`) for auto-format/layout optimization, updated planning index/status, moved closed clef risk `R-021` into `todo.completed.md`, and added open bug tracking for unsupported extreme durations (`B-006`).
- 2026-02-11: Rechecked `B-003` proof-point (`realworld-music21-beethoven-op18no1-m1`) after clef fixes; spacing ratio remains `0.6459` with clean intrusion/beam/curve diagnostics, so the item stays OPEN pending spacing-gate calibration or further formatter tuning.
- 2026-02-11: Fixed CI portability regression in VexFlow gap registry checks by replacing machine-specific absolute paths with workspace-relative paths in `fixtures/vexflow/gap-registry.json`, adding workspace-aware path resolution in `src/testkit/vexflow-gap-registry.ts`, and updating gap-check/brief scripts to use `path.resolve(...)` defaults.
- 2026-02-11: Revalidated CI-equivalent gates after portability fix (`tests/integration/vexflow-gap-registry.test.ts`, `npm run vexflow:gaps:check`, `npm run vexflow:gaps:brief`, full `npm run test`, `npm run lint`, `npm run typecheck`) — all green.
- 2026-02-11: Added per-band spacing triage output to `npm run inspect:score` (min/max band ratio + compressed-band count) to accelerate B-003 investigation; current `realworld-music21-beethoven-op18no1-m1` snapshot reports `compressed(<0.75)=6/8` with min band ratio `0.2753`.
- 2026-02-11: Continued M10D/M8B remediation with density-aware layout tuning in `src/vexflow/render.ts`: expanded dense-column minimum widths, added peak-local dense-rhythm pressure for system wrapping, and strengthened grand-staff intra-part spacing heuristics for center-register/tie-heavy writing.
- 2026-02-11: Retuned demo output geometry in `scripts/build-demos.mjs` (`layout.scale=1.1`, page `980x1400`, tighter page margins, wider site container, centered SVG max-width) to improve browser readability and reduce right-side whitespace.
- 2026-02-11: Extended renderer regression gates in `tests/integration/render-quality-regressions.test.ts` with `lilypond-03a-rhythm-durations` spacing-band checks and a Schumann proof-point anti-catastrophic spacing guard.
- 2026-02-11: Revalidated targeted gates and quality checks: `npm run lint`, `npm run typecheck`, `npm run test -- tests/integration/render-quality-regressions.test.ts tests/integration/vexflow-gap-registry.test.ts`, `npm run demos:build`, plus `npm run inspect:score` for `lilypond-03a-rhythm-durations` and `realworld-music21-schumann-clara-polonaise-op1n1`.
- 2026-02-11: Re-ran `B-003` proof-point after dense-layout tuning (`realworld-music21-beethoven-op18no1-m1`): spacing moved from severe compression to partial compression (`compressed bands: 6/8 -> 1/8`, `min band ratio: 0.2753 -> 0.5577`, first/median ratio `~1.0994`), so backlog status advanced from OPEN to MITIGATING.
- 2026-02-11: Reset demo rendering scale to match library default (`0.8`) in `scripts/build-demos.mjs` per user request, then rebuilt demos.
- 2026-02-11: Ran follow-up M10D spacing tuning: added score-level grand-staff pressure to auto-wrap planning, increased intra-staff gap envelope, and blended density with source width hints in system column allocation; validated with `tests/integration/render-quality-regressions.test.ts` and `inspect:score` on Schumann/op18/03a fixtures.
- 2026-02-11: Outcome of follow-up tuning: `lilypond-03a-rhythm-durations` remains clean (`barlineIntrusions=0`, `compressed=0/2`), `realworld-music21-beethoven-op18no1-m1` remains partial compression (`compressed=1/8`, `min ratio ~0.5577`), and `realworld-music21-schumann-clara-polonaise-op1n1` still shows residual compressed bands (`min ratio ~0.671`); no regression in beam/flag or curve anomaly checks.
- 2026-02-12: Continued M8B/M10D remediation and demo-quality execution: parser now aggregates repeated `<notations>` blocks (articulations/ornaments/slurs/tuplets), direction parsing keeps compound direction-type words/metronome payloads, and category-32 rendering now maps broader tokens to VexFlow modifiers (`Articulation`, `Ornament`, `Vibrato`, `Stroke`, `FretHandFinger`, `Tremolo`) with annotation fallbacks for remaining technical symbols.
- 2026-02-12: Added deterministic regression coverage for multi-notation parsing + category-32 modifier attachment (`tests/integration/parser-csm.test.ts`, `tests/unit/render-note-mapper.test.ts`) and revalidated end-to-end with `npm run lint`, `npm run typecheck`, and full `npm run test` (all passing).
- 2026-02-12: Expanded real-world complexity corpus by importing 3 new active conformance fixtures (`realworld-music21-beethoven-op59no2-m1`, `realworld-music21-mozart-k458-m1`, `realworld-music21-bach-bwv244-10`) via `npm run conformance:realworld:import`; active conformance set is now 179 fixtures (174 pass / 5 fail expected outcomes).
- 2026-02-12: Improved demo-site ergonomics: demo render scale set to `0.7`, LilyPond category labels now show `ID + Name`, and SVG trimming now uses notation-first bounds with nearby-text inclusion to reduce oversized blank canvas areas.
- 2026-02-12: Revalidated key proof-points with headless inspection: `03a-rhythm-durations` remains overflow-clean (`barlineIntrusions=0`, spacing min band `0.9676`), `schumann-clara-polonaise-op1n1` improved but still compressed in dense bands (`compressed 2/6`, min band `0.671`), and `32a-notations` now maps most notation symbols but still has high text overlap pressure (`text overlaps=21`) tracked for follow-up.
- 2026-02-12: Refreshed headless visual baselines after notation/layout changes (`npm run test:visual:headless:update`) and revalidated (`npm run test:visual:headless` passes 8/8 fixtures).
- 2026-02-12: Continued M8B quality hardening for LilyPond categories 31/32: deduplicated chord-level articulation/ornament modifiers, added per-note compact routing for technical text/fingerings, and enabled overlap-aware row packing for direction text. Headless inspection improved from `31a overlaps 13 -> 7` and `32a overlaps 21 -> 4`; remaining unsupported symbol is `NON_ARPEGGIATE_UNSUPPORTED`.
- 2026-02-12: Added deterministic regression gates for category-31/32 readability and unsupported-symbol coverage in `tests/integration/render-quality-regressions.test.ts` (thresholds `31a <= 8`, `32a <= 6`), updated VexFlow gap registry with `VF-GAP-002` (non-arpeggiate), and revalidated with `npm run lint`, `npm run typecheck`, `npm run test`, `npm run demos:build`, `npm run test:visual:headless`, and `npm run vexflow:gaps:check`.
- 2026-02-12: Completed modular refactor pass for maintainability across `src/vexflow`, `src/parser`, and `src/testkit` by extracting long files into cohesive modules (`render-drawing`, `render-notations-{core,text,spanners}`, `render-note-mapper-mappings`, `parse-note-{data,notations}`, `parse-direction-events`, `parse-measure-events`, and conformance quality/report/type modules), preserving public behavior and updating module READMEs; added targeted extraction regression tests (`tests/unit/parser-refactor.test.ts`, `tests/unit/conformance-refactor.test.ts`) and revalidated with `npm run lint`, `npm run typecheck`, and full `npm run test` (23 files / 134 tests passing).
- 2026-02-12: Landed targeted rendering regression fixes after refactor: (1) stronger first-column spacing reservation with source-width-aware guardrails in `src/vexflow/render.ts`, (2) expanded vertical spacing pressure model for ledger-heavy cross-staff passages in `src/vexflow/render.ts`, (3) tighter tie/slur stability routing in `src/vexflow/render-notations-spanners.ts` (anchor-delta guardrails, stable tie direction, curve depth tuning), and (4) switched direction dynamics from plain text to SMuFL glyph rendering (`vf-dynamics-text`) in `src/vexflow/render-notations-text.ts`; updated notation SVG expectations in `tests/svg/render-structure.test.ts` and revalidated with full `npm run test` (23 files / 134 tests passing).
- 2026-02-12: Processed Review-3 feedback (`feedback-R3.md`) and accepted all items (`F-025`..`F-039`) with explicit milestone/backlog tracking; re-baselined execution order to linear closeout (M10D blockers -> M8 -> M9 -> M12), opened `milestone-12.md` for structural completeness work (multi-voice + missing notation families + completeness-aware quality model), and added new blocking bugs for current regressions (`B-011` left-bar squeeze/overflow on bwv244/k458, `B-012` dynamic-glyph lane collisions).
- 2026-02-12: Landed generalized first-column spacing hardening in `src/vexflow/render.ts` by propagating minimum-width constraints through the justify/shrink path (`expandColumnWidthsToFit(..., minimumWidths)`) and capping first-column justification floor against even-split width; this removed first-system left-bar compression on `realworld-music21-mozart-k458-m1` and `realworld-music21-bach-bwv244-10` without fixture-specific hacks.
- 2026-02-12: Revalidated M10D spacing proof-points with headless inspection after the layout fix: `k458` now reports `barlineIntrusions=0`, `compressed bands=0/8`, `min band ratio=0.9161`; `bwv244-10` now reports `barlineIntrusions=0`, `compressed bands=0/8`, `min band ratio=1.0`; `03a-rhythm-durations` remains overflow-clean (`compressed=0/2`).
- 2026-02-12: Tuned demo-site whitespace trimming in `scripts/build-demos.mjs` (reduced text inclusion paddings), rebuilt demos, and revalidated targeted gates: `npm run test -- tests/integration/render-quality-regressions.test.ts`, `npm run test -- tests/integration/vexflow-gap-registry.test.ts`, and `npm run demos:build` all pass.
- 2026-02-12: Continued M10D spacing hardening with generalized first-column density guards in `src/vexflow/render.ts` (higher bounded first-column density floor + density-driven extra width reserve) and revalidated proof-points via `npm run inspect:score`.
- 2026-02-12: Added cross-staff proximity pressure to grand-staff intra-gap estimation to reduce treble/bass crowding in dense piano systems; Schumann visual crowding improved, but one compressed spacing band remains (`compressed 1/6`, `min ratio 0.6822`), so `B-007` remains open.
- 2026-02-12: Revalidated key fixtures after changes: `realworld-music21-bach-bwv244-10` now reports `barlineIntrusions=0`, `compressed bands=0/8`, `min ratio=0.7623`; `realworld-music21-mozart-k458-m1` remains `compressed 0/8`; `lilypond-01a-pitches-pitches` and `lilypond-03a-rhythm-durations` remain clean.
- 2026-02-12: Ran full validation gates post-change: `npm run lint`, `npm run typecheck`, `npm run test` (23 files / 137 tests), and `npm run demos:build` all pass.
- 2026-02-12: Fixed multi-staff direction default routing so directions without explicit `staff` render once on staff 1 (top staff) instead of duplicating on every staff; this removes a generalized source of repeated `f/sf/...` glyph collisions.
- 2026-02-12: Revalidated targeted gates after direction routing + spacing updates: `tests/integration/render-quality-regressions.test.ts`, `tests/integration/public-api.test.ts`, `npm run lint`, `npm run typecheck`, and `npm run demos:build` all pass.
- 2026-02-12: Ran full post-fix validation after direction default-staff routing update: `npm run test` (23 files / 137 tests), `npm run lint`, `npm run typecheck`, and `npm run demos:build` all pass.
- 2026-02-12: Hardened deterministic regression budgets after spacing/lane fixes: `k458` page-1 now requires zero compressed bands; `bwv244-10` page-1 now requires zero compressed bands with minimum band ratio `>0.75`; category-31 direction overlap budgets tightened to `<=4` for both text-only and dynamics-vs-text checks.
- 2026-02-12: Added local dense-measure adaptive system splitting in `src/vexflow/render.ts` (`buildSystemRanges` now reduces measures-per-system for dense local windows), plus shared per-measure density-hint extraction for both system planning and column allocation.
- 2026-02-12: Post-adaptation proof-point snapshot: `bwv244-10` page 1 now `compressed bands=0/4` (`min ratio=1.0`), `k458` remains `0/8`, `03a` remains overflow-clean (`0/3`), and Schumann improved to `compressed bands=1/4` (`min ratio=0.695`) but remains open under `B-007`.
- 2026-02-13: Added density-aware spacing-band telemetry in `src/testkit/notation-geometry.ts` (`firstMeasureNoteheadCount`, `medianOtherMeasuresNoteheadCount`, `firstToMedianOtherEstimatedWidthRatio`) and updated `scripts/inspect-score-headless.mjs` to classify compressed bands using width-ratio instead of raw gap ratio.
- 2026-02-13: Added deterministic unit regression coverage in `tests/unit/notation-geometry.test.ts` to prevent false compression positives when first measures are rhythmically denser but not width-starved.
- 2026-02-13: Revalidated after telemetry update: `npm run test:unit -- tests/unit/notation-geometry.test.ts`, `npm run test:integration`, `npm run lint`, `npm run typecheck`, `npm run demos:build`, and proof-point inspections for Schumann/BWV244/K458.
- 2026-02-13: Schumann proof-point now reports `compressed(<0.75 width-ratio)=0/4` with `minWidthRatio=1.1583`; raw min gap ratio remains `0.695` and is now tracked as a density artifact rather than a compression blocker.
- 2026-02-13: Final validation after spacing telemetry update: `npm run test` (23 files / 138 tests) and `npm run demos:build` both pass.
- 2026-02-13: Updated integration spacing gates to consume density-aware compression ratios (`firstToMedianOtherEstimatedWidthRatio` fallback to gap ratio) in `tests/integration/render-quality-regressions.test.ts` for Schumann/K458/BWV244 proof-points.
- 2026-02-13: Revalidated final gates after test updates: `npm run test` (23 files / 138 tests) and `npm run demos:build` pass.
- 2026-02-13: Continued `B-012` mitigation with generalized direction/dynamics lane tuning in `src/vexflow/render-notations-text.ts` (row spacing increase, placement-specific dynamics baseline shifts, and dynamics-word dedupe when semantically equivalent).
- 2026-02-13: Revalidated category direction/notation fixtures via `npm run inspect:score` on `31a-Directions`, `32a-Notations`, and Schumann proof-point; current snapshots are `31a text overlaps=0`, `32a text overlaps=4`, and Schumann `compressed(<0.75 width-ratio)=0/4`.
- 2026-02-13: Revalidated full gates after lane tuning: `npm run lint`, `npm run typecheck`, `npm run test` (23 files / 138 tests), and `npm run demos:build` all pass.
- 2026-02-12: Hardened notation text lane routing in `src/vexflow/render-notations-text.ts` by introducing interval-based row occupancy checks (order-independent) and applying them to directions, harmonies, and lyrics.
- 2026-02-12: Added per-system lane-state persistence for directions/harmonies/lyrics in `src/vexflow/render.ts` so row packing no longer resets at every measure boundary.
- 2026-02-12: Increased text-lane vertical clearance constants (`DIRECTION_BOTTOM_BASE_OFFSET`, `HARMONY_ROW_SPACING`, `LYRIC_ROW_SPACING`) to reduce direction-vs-lyric collisions in category-31/71 fixtures.
- 2026-02-12: Added deterministic regression gate for `31d-directions-compounds` in `tests/integration/render-quality-regressions.test.ts` with overlap budget `<= 4`.
- 2026-02-12: Revalidated targeted fixtures via `npm run inspect:score`:
  - `31d-directions-compounds` overlaps improved `8 -> 4`.
  - `71f-allchordtypes` overlaps improved `10 -> 5`.
  - `31a-Directions` remains `0` overlaps.
  - `61b-multiplelyrics` remains `0` overlaps.
- 2026-02-12: Revalidated lane-routing updates with `npm run lint`, `npm run typecheck`, `npm run test -- tests/integration/render-quality-regressions.test.ts`, full `npm run test` (23 files / 139 tests), and `npm run demos:build` (165 demos + roadmap, 179 active fixtures) — all passing.
- 2026-02-12: Final revalidation after text-lane constant tuning/revert: `npm run lint`, `npm run typecheck`, targeted `render-quality-regressions` integration suite, full `npm run test` (23 files / 139 tests), and `npm run demos:build` all pass.
- 2026-02-12: Added score-level text-pressure-aware automatic system-gap expansion in `src/vexflow/render.ts` (active only when callers do not explicitly set `layout.system.minSystemGap`) to prevent cross-system text-lane collisions.
- 2026-02-12: Added deterministic regression gate for `71f-allchordtypes` text overlap bounds (`<= 3`) in `tests/integration/render-quality-regressions.test.ts`.
- 2026-02-12: Post-fix headless inspections: `71f` overlaps `5 -> 1`, `31d` overlaps `4 -> 1`, `31a` overlaps `2`, `61b` overlaps `0`.
- 2026-02-12: Revalidated with `npm run test:conformance:report`; expected-pass quality summary remains stable (`expectedPassWeightedMean=4.8688`, critical collisions=0).
- 2026-02-12: Final verification after this wave: `npm run lint`, `npm run typecheck`, targeted + full tests (`23 files / 140 tests`), and `npm run demos:build` all pass.
- 2026-02-13: Continued M10D/B-012 text-lane hardening with generalized harmony-label packing improvements in `src/vexflow/render-notations-text.ts` (style-accurate bold/italic width measurement, side-padding row spans, larger harmony row-search budget) to remove remaining dense-label collisions without fixture-specific hacks.
- 2026-02-13: Added compact harmony-kind formatting in `src/vexflow/render-notations-text.ts` (e.g., `major-seventh -> maj7`, `minor -> m`, `dominant -> 7`) with preservation of explicitly styled custom text; updated SVG structure expectation test to match compact chord labels.
- 2026-02-13: Tuned inter-system text-pressure expansion in `src/vexflow/render.ts` by separating lane-collision pressure (lyrics/harmony/direction words) from compact dynamics-only pressure so pagination spacing remains collision-safe without over-expanding dynamic-only systems.
- 2026-02-13: Revalidated targeted inspections (`71f`, `71g`, `31d`, Schumann pages) and full gates: `npm run lint`, `npm run typecheck`, `npm run test` (23 files / 140 tests), and `npm run demos:build` all pass.
- 2026-02-13: Increased vertical-spacing sensitivity for extreme ledger-register passages in `src/vexflow/render.ts` by blending average/peak/elevated spread pressure in `estimatePartVerticalSpread` and increasing inter-part vertical spread weighting in `resolveInterPartGap`.
- 2026-02-13: Added deterministic integration coverage for extreme-register spacing in `tests/integration/public-api.test.ts` (`expands inter-part gap for extreme ledger-register passages`).
- 2026-02-13: Refined spacing-band width-ratio telemetry in `src/testkit/notation-geometry.ts` so note-count normalization is only applied when the first measure is denser than later measures, eliminating sparse-opening false positives.
- 2026-02-13: Added sparse-opening regression coverage in `tests/unit/notation-geometry.test.ts`; `lilypond-01a-pitches-pitches` inspection now reports `minWidthRatio=1` and `compressed(<0.75 width-ratio)=0/5`.
- 2026-02-13: Revalidated targeted gates after this pass: `npm run test -- tests/unit/notation-geometry.test.ts`, `npm run test -- tests/integration/public-api.test.ts`, `npm run test -- tests/integration/render-quality-regressions.test.ts`, `npm run lint`, `npm run typecheck`, and `npm run demos:build` (all passing).
- 2026-02-13: Added shared fast-loop execution helpers in `src/testkit/execution-loop.ts` (`parseCsvArgument`, `runWithConcurrency`, `summarizeDurations`) with deterministic unit coverage (`tests/unit/execution-loop.test.ts`), and wired these helpers into script orchestration paths.
- 2026-02-13: Added reusable fixture render-cache plumbing (`scripts/lib/fixture-render-cache.mjs`) and integrated it into `run-headless-visual-regression.mjs`, `run-golden-comparison.mjs`, and `inspect-score-headless.mjs`; added cache controls (`--no-cache`, `--cache-dir`) plus concurrency/timing telemetry support in compare loops.
- 2026-02-13: Expanded `scripts/build-demos.mjs` for incremental/parallel runs (`--fixtures`, `--changed-from`, `--concurrency`, `--no-clean`, `--with-index`, `--with-roadmap`, timing budget flags) and exposed fast-loop scripts in `package.json` (`loop:quick`, `loop:targeted`, `loop:full`, `demos:build:fixtures`, `demos:build:changed`, `test:golden:fixtures`, `eval:run:fixtures`, `check:parallel`).
- 2026-02-13: Added `scripts/run-hot-fixture-pack.mjs` + `npm run triage:fixtures` to run golden/headless/inspect in one report-oriented pass, and documented fast-loop usage in `README.md`, `AGENTS.md`, and `docs/iteration-speed-tips.md`.
- 2026-02-13: Hardened triage reliability by adding `--allow-blocking-failures` to `run-golden-comparison.mjs` and updating `run-hot-fixture-pack.mjs` to (a) run golden in report-first mode by default, and (b) skip headless visual checks when selected fixtures are outside sentinel scope; strict mode still enforces command failures.
- 2026-02-13: Tightened direction/chord overlap regression budgets in `tests/integration/render-quality-regressions.test.ts` (`31a text<=2`, `31a dynamics/text<=2`, `31d<=2`, `71f<=1`, `32a<=4`) based on current measured baselines, then revalidated with `npm run test -- tests/integration/render-quality-regressions.test.ts`, `npm run lint`, and `npm run typecheck` (all passing).
- 2026-02-14: Closed `B-012` by extending tighter overlap gates to a broader category-31/71 sweep in `tests/integration/render-quality-regressions.test.ts` (`31b`, `31c`, `31f`, `71a`, `71c`, `71d`, `71e` now gated at zero text overlaps while existing tight budgets remain in place for `31a/31d/71f`).
- 2026-02-14: Continued `B-003`/`B-007` with later-page coverage by upgrading Schumann regression checks to evaluate every rendered page for sparse-page compression and curve stability (`compressed(<0.75 width-ratio)=0`, `extremeCurveCount=0`, and no tie/slur anchor-delta fallback diagnostics).
- 2026-02-14: Started `B-010` mitigation by mapping non-arpeggiate ornaments to a VexFlow-compatible brush-stroke fallback (`src/vexflow/render-note-mapper-mappings.ts`), replacing unsupported diagnostics with explicit fallback diagnostics (`NON_ARPEGGIATE_FALLBACK_RENDERED`), and updating `VF-GAP-002` in `fixtures/vexflow/gap-registry.json` to `local_patch`.
- 2026-02-14: Added/updated deterministic tests for this wave: non-arpeggiate fallback unit coverage (`tests/unit/render-note-mapper.test.ts`) and category-32 fallback assertions (`tests/integration/render-quality-regressions.test.ts`), then revalidated with `npm run test -- tests/unit/render-note-mapper.test.ts tests/integration/render-quality-regressions.test.ts tests/integration/vexflow-gap-registry.test.ts` (31 tests passing).
- 2026-02-14: Upgraded `B-010` fallback rendering to a bracket-style pass (`drawMeasureNonArpeggiates`) that draws explicit non-arpeggiate brackets in SVG (`vf-non-arpeggiate-bracket`) instead of brush-stroke approximation; kept diagnostics explicit (`NON_ARPEGGIATE_FALLBACK_RENDERED`) and removed unsupported warnings.
- 2026-02-14: Extended multi-page `B-003/B-007` sparse/curve stability gates in `tests/integration/render-quality-regressions.test.ts` to additional real-world fixtures (`realworld-music21-mozart-k545-exposition`, `realworld-music21-berlin-alexanders-ragtime`) with per-page compression and extreme-curve assertions.
- 2026-02-14: Added category-32 bracket fallback regression coverage for `lilypond-32d-arpeggio` and bracket-presence assertions for `lilypond-32a-notations`.
- 2026-02-14: Revalidated this follow-up wave with `npm run test -- tests/unit/render-note-mapper.test.ts tests/integration/render-quality-regressions.test.ts`, `npm run test -- tests/integration/vexflow-gap-registry.test.ts`, `npm run vexflow:gaps:check`, and `npm run vexflow:gaps:brief` (all passing; upstream brief artifacts regenerated).
- 2026-02-14: Continued `B-003/B-007` promotion by adding sampled long-form page gating for `realworld-music21-beethoven-op133-longform` in `tests/integration/render-quality-regressions.test.ts` (page-count sanity + sampled per-page spacing/curve checks).
- 2026-02-14: Revalidated with `npm run test -- tests/integration/render-quality-regressions.test.ts` (22 tests passing, including the new long-form gate).
- 2026-02-14: Further promoted `B-003/B-007` proof-point blocking by adding `realworld-music21-bach-bwv1-6` to the full-page multi-page sparse/curve stability gate list in `tests/integration/render-quality-regressions.test.ts`.
- 2026-02-14: Revalidated after this promotion with `npm run test -- tests/integration/render-quality-regressions.test.ts` (22 tests passing).
- 2026-02-14: Continued `B-003/B-007` promotion by adding `realworld-music21-bach-bwv244-10` to the same full-page multi-page sparse/curve stability gate list in `tests/integration/render-quality-regressions.test.ts`.
- 2026-02-14: Revalidated after this additional promotion with `npm run test -- tests/integration/render-quality-regressions.test.ts` (22 tests passing).
- 2026-02-14: Added memory-safe long-form sparse/curve probing via `scripts/probe-page-quality.mjs` (subprocess SVG page analysis) and switched op133-class regression gating to out-of-process full-page checks in `tests/integration/render-quality-regressions.test.ts`.
- 2026-02-14: Promoted two additional long-form fixtures to blocking full-page gates (`realworld-music21-bach-bwv248-42-4`, `realworld-openscore-lieder-just-for-today`) alongside `realworld-music21-beethoven-op133-longform`, using per-fixture compressed-band/page budgets plus curve-stability assertions.
- 2026-02-14: Revalidated this wave with `npm run test -- tests/unit/render-note-mapper.test.ts tests/integration/vexflow-gap-registry.test.ts tests/integration/render-quality-regressions.test.ts`, `npm run lint`, `npm run typecheck`, `npm run vexflow:gaps:check`, and `npm run vexflow:gaps:brief` (all passing).
- 2026-02-14: Full-page long-form sweeps show tie/curve stability holding but residual sparse-band compression outliers on later pages (op133/bwv248/lieder), so `B-003`/`B-007` remain MITIGATING and are not closed in this pass.
- 2026-02-14: Added planning-only follow-up items from new layout/pagination feedback (no implementation in this step): opened `B-013` (sparse-system horizontal stretch) and `B-014` (vertical over-expansion) plus `R-036` (pagination/API completeness: measure-range rendering, overflow telemetry, measure-number options, and demo prev/next controls).
- 2026-02-14: Re-prioritized M10D execution order in planning docs so `B-013`/`B-014` and `R-036` are explicit blockers before M8/M9 closeout handoff.
- 2026-02-14: Implemented generalized M10D compaction policies in `src/vexflow/render.ts`: sparse justified systems now compact by density-aware target width, and vertical spacing now applies bounded low-risk compaction for both grand-staff and inter-part gaps.
- 2026-02-14: Implemented M10D pagination/API completeness features in renderer/public API (`src/vexflow/render-types.ts`, `src/public/api.ts`, `src/vexflow/render.ts`): partial measure-window rendering (`layout.window`), per-page telemetry (`pageMetrics` with bounds + overflow indicators), and configurable measure-number overlays (`layout.measureNumbers`).
- 2026-02-14: Added deterministic integration coverage for the new API/compaction surfaces in `tests/integration/public-api.test.ts` (partial-window telemetry, overflow reporting, measure-number overlays, sparse-system compaction, bounded sparse grand-staff gaps).
- 2026-02-14: Upgraded demo generation in `scripts/build-demos.mjs` to render all pages and include first-class prev/next navigation with page indicators and per-page overflow summaries; validated with `npm run demos:build:fixtures -- --fixtures realworld-music21-bach-bwv1-6`.
- 2026-02-14: Revalidated M10D suites after this wave (`npm run test -- tests/integration/public-api.test.ts`, `npm run test -- tests/integration/render-quality-regressions.test.ts`, `npm run lint`, `npm run typecheck` all passing) and tightened stable long-form lieder budgets in `tests/integration/render-quality-regressions.test.ts` (`maxCompressedBands=6`, `maxCompressedPages=3`).
- 2026-02-14: Long-form sparse-band outliers for op133/bwv248 remain unchanged (`op133 compressedBands=14`, `bwv248 compressedBands=18` in out-of-process sweeps), so `B-003`/`B-007` remain MITIGATING and are not closed in this pass.
- 2026-02-14: Reprioritized M10D closeout order so `B-003`/`B-007` are explicitly opportunistic (still MITIGATING) while the mainline focuses on promotion-confidence work for `B-013`/`B-014`/`R-036` plus `B-010` parity/upstream prep before M8/M9 closeout.
- 2026-02-14: Promoted compaction blocker confidence by adding additional real-world gates in `tests/integration/render-quality-regressions.test.ts`: horizontal sparse-compaction envelopes on `realworld-music21-mozart-k545-exposition` + `realworld-music21-berlin-alexanders-ragtime`, and paired-staff vertical-gap envelopes on `realworld-music21-schumann-clara-polonaise-op1n1` + `realworld-openscore-lieder-just-for-today`.
- 2026-02-14: Promoted `R-036` confidence by adding multi-page real-world API telemetry + measure-window slicing checks in `tests/integration/public-api.test.ts` and demo pager telemetry payload checks in `tests/integration/demos.test.ts` for `realworld-music21-bach-bwv1-6` and `realworld-music21-schumann-clara-polonaise-op1n1`.
- 2026-02-14: Strengthened `B-010` parity proof-points by enforcing non-arpeggiate marker/diagnostic and anchor/bracket cardinality alignment on `lilypond-32a-notations` + `lilypond-32d-arpeggio` and updated `VF-GAP-002` upstream follow-up notes (`fixtures/vexflow/gap-registry.json`, `docs/vexflow-upstream-sync-log.md`).
- 2026-02-14: Revalidated this promotion wave with `npm run test -- tests/integration/render-quality-regressions.test.ts tests/integration/public-api.test.ts tests/integration/demos.test.ts tests/integration/vexflow-gap-registry.test.ts`, `npm run lint`, and `npm run typecheck` (all passing).
