## Progress Log (Append-Only)
- 2026-02-10: Initial strategy drafted with M0-M7 milestone structure and test-first approach.
- 2026-02-10: Integrated Review 1 feedback (`F-001` to `F-016`). Switched to single-package early architecture, added CSM sketch, split sync/async parse API, defined strict/lenient behavior, moved Playwright to M2, moved collision audits to M3, added timewise plan, added distribution/patch strategy details, and updated conformance metadata scaling strategy.
- 2026-02-10: Integrated Review 2 feedback (`F-017` to `F-024`). Removed encoding artifacts from CSM events, clarified chord modeling, added explicit `ticksPerQuarter`, added `EffectiveAttributes`/spanner/diagnostic type sketches, clarified `.mxl` implementation timing, and pinned Vitest as the M0 test runner.
- 2026-02-10: Began M0 implementation. Added single-package TypeScript scaffold, ESLint/Prettier/Vitest configs, CI workflow, initial public API placeholders, conformance metadata schema, fixture loader, and baseline unit/integration/conformance tests.
- 2026-02-10: Completed M0 validation. `npm run lint`, `npm run typecheck`, `npm run build`, `npm run test`, `npm run test:unit`, `npm run test:integration`, and `npm run test:conformance` all pass locally.
- 2026-02-10: Completed M1 parser baseline. Added `saxes` XML AST with location/path tracking, implemented `score-partwise` AST-to-CSM parsing (parts/measures/attributes/voices/notes/rests/chords, backup/forward normalization), strict/lenient diagnostics, score-timewise detection, ADR-0001 + parser/diagnostics/CSM docs, and expanded integration/unit coverage.
- 2026-02-10: Completed M2 rendering baseline implementation. Added `src/vexflow/render.ts` mapper for clef/key/time + notes/rests/barlines, wired `renderToSVGPages` and `renderToElement` through public API, introduced `tests/svg/render-structure.test.ts`, and added Playwright smoke harness (`playwright.config.ts`, `tests/visual/render-visual.spec.ts`) with CI SVG gate updates.
- 2026-02-10: Completed M2 documentation/state sync. Added `docs/rendering-pipeline.md`, updated README and VexFlow adapter docs, and validated browser render smoke via Playwright MCP (SVG present with expected stave/note/barline structure and captured screenshot artifact).
- 2026-02-10: Applied design/commenting conformance pass across parser/renderer/public API/testkit/core model files. Added detailed API/function/type comments and renderer config hardening for local Playwright executable resolution across architecture variants.
- 2026-02-10: Refactored parser into cohesive modules (`parse-context`, `xml-utils`, `parse-header`, `parse-note`, `parse-timing`, `parse-constants`) and reduced `parse.ts` to orchestration + part/measure control flow while preserving test behavior.
- 2026-02-10: Refactored VexFlow renderer into cohesive modules (`render-types`, `render-dom`, `render-note-mapper`) and reduced `render.ts` to orchestration/layout flow while preserving M2 rendering behavior and test results.
- 2026-02-10: Started M3 implementation by adding score-timewise normalization (`src/parser/parse-timewise.ts`) and integrating root-level normalization in parser orchestration.
- 2026-02-10: Added M3 normalization coverage in integration tests (`tests/integration/public-api.test.ts`, `tests/integration/parser-csm.test.ts`) covering multi-part/missing-part-measure timewise cases.
- 2026-02-10: Added M3 `.mxl` baseline extraction path (`src/parser/mxl.ts`) with ZIP central-directory parsing, `META-INF/container.xml` rootfile resolution, and diagnostic-backed fallback score lookup.
- 2026-02-10: Integrated `.mxl` extraction into `parseMusicXMLAsync` and added async integration coverage for container resolution, fallback behavior, strict-mode escalation, and invalid archive diagnostics.
- 2026-02-10: Added M3 timing-model consistency diagnostics for stream-cursor anomalies (`BACKUP_BEFORE_MEASURE_START`, `MEASURE_CURSOR_OVERFLOW`) in measure parsing.
- 2026-02-10: Added deterministic property-style integration tests for randomized two-voice `backup`/`forward` timing conservation and expanded parser invariant coverage.
- 2026-02-10: Added first headless collision-audit helpers (`src/testkit/svg-collision.ts`) with SVG bounds extraction, overlap detection, and dedicated `tests/svg/collision-audit.test.ts` coverage (synthetic + rendered fixtures).
- 2026-02-10: Expanded `.mxl` parser integration coverage for container/rootfile edge cases (missing referenced score path, malformed `container.xml` fallback, unsupported compression method, truncated archive handling).
- 2026-02-10: Added conformance collision-audit metadata/report workflow (`collision_audit` schema + loader validation + `runConformanceCollisionAudit`) with dedicated tests and smoke fixture wiring.
- 2026-02-10: Added initial conformance execution test path (`tests/conformance/execution.test.ts`) that runs active fixtures end-to-end through parse/render and applies collision-audit pass/fail checks from metadata.
- 2026-02-10: Refactored conformance execution into reusable testkit module (`src/testkit/conformance-execution.ts`) with aggregate result types and markdown/json report formatting helpers.
- 2026-02-10: Added report artifact emission path (`npm run test:conformance:report`) writing `artifacts/conformance/conformance-report.{json,md}`.
- 2026-02-10: Added staged `timewise` and `rhythm` conformance fixtures (`minimal-timewise`, `backup-forward-two-voices`) and expanded conformance execution tests to cover all active fixtures.
- 2026-02-10: Added M3 timing-model design note (`docs/timing-model.md`) documenting cursor invariants, backup/forward/chord normalization semantics, and diagnostic mappings.
- 2026-02-10: Added expected-vs-observed conformance execution semantics and introduced first active expected-fail fixture (`parser-malformed-xml`) to enforce expected-fail gating behavior.
- 2026-02-10: Added AI acceleration context files (`ai-state.md`, `docs/musicxml-tips.md`, `docs/vexflow-tips.md`, `docs/playwright-tips.md`) for faster dependency/tooling rehydration.
- 2026-02-10: Added conformance report diagnostic histograms (parse/render code + severity aggregates) and markdown rendering sections for faster failure triage.
- 2026-02-10: Added conformance report category rollups keyed by fixture category, including per-category pass/fail and diagnostic histogram aggregates.
- 2026-02-10: Added Playwright visual sentinel specs (`tests/visual/conformance-sentinels.spec.ts`) covering active `smoke`, `timewise`, and `rhythm` pass fixtures.
- 2026-02-10: Re-ran Playwright visual suite under elevated permissions; `npm run test:visual` passed for all sentinel + smoke visual tests.
- 2026-02-10: Added concrete expected-fail conformance fixtures for unsupported root handling (`parser-unsupported-root-opus`) and malformed `.mxl` archive handling (`mxl-invalid-container`) with execution/report assertions.
- 2026-02-10: Added fixture-level conformance `parse_mode` support (`strict`/`lenient`) and notation strict-vs-lenient fixture pair (`notation-invalid-pitch-step-*`) to validate nuanced warning-vs-error expected behavior.
- 2026-02-10: Added Playwright visual snapshot assertions and generated baseline images for smoke + conformance sentinel suites via `npm run test:visual:update`.
- 2026-02-10: Completed M3 milestone and advanced next-step focus to M4 notation/direction implementation scope.
- 2026-02-10: Implemented M4 parser/model notation flow: direction dynamics/wedges, note slurs, and post-parse spanner linking for ties/slurs/wedges with strict-mode diagnostic escalation coverage.
- 2026-02-10: Implemented M4 renderer notation flow: articulation mapping, direction text placement, and tie/slur/wedge drawing; corrected VexFlow API integration (`Curve` options, `StaveHairpin` note keys/options) and stabilized render diagnostics.
- 2026-02-10: Expanded M4 tests: parser continuity assertions for tie/slur/wedge, note-mapper articulation unit tests, SVG structure assertions for notation baseline, conformance assertions for `notation-m4-baseline`, and visual sentinel coverage/snapshots for notation baseline.
- 2026-02-10: Completed M4 docs/state sync: updated README milestone/status, refreshed rendering/CSM/diagnostic docs, and added `docs/notation-support-matrix.md` plus `plan.md`/`todo.md`/`ai-state.md` milestone state updates.
- 2026-02-10: Started M5 renderer layout baseline by replacing single-part rendering with multi-part/multi-staff system layout, per-staff note routing, and connector drawing (`singleLeft`, `brace`, `bracket`).
- 2026-02-10: Added M5 tests for staff routing and layout structure across unit/integration/svg layers and preserved passing deterministic headless suite gates.
- 2026-02-10: Added active M5 conformance layout fixture (`layout-m5-multipart-baseline`) and expanded Playwright visual sentinels with a new snapshot baseline for multi-part/multi-staff layout output.
- 2026-02-10: Added M5 lyric/harmony parser support (`<harmony>`, `<lyric>`) and renderer text attachment passes with deterministic headless text-width estimation.
- 2026-02-10: Extended part-list parsing to include MusicXML `part-group` semantics, surfaced via `PartDefinition.groupPath`, and mapped group symbols to connector styles during rendering.
- 2026-02-10: Added text-aware SVG collision bounds (`<text>`) and promoted text overlap checks via new conformance fixture `text-m5-lyrics-harmony-baseline`.
- 2026-02-10: Completed M5 documentation gates with `docs/layout-heuristics.md` and `docs/modularization-decision.md`; milestone state advanced to completed.
- 2026-02-10: Implemented M6 parser/model features for grace/cue note flags, ornament tokens, tuplet endpoint/ratio metadata, and repeat/ending barline metadata aggregation.
- 2026-02-10: Implemented M6 renderer features for grace-note attachment, cue-size rendering, ornament modifiers, tuplet draw pass, and repeat/ending stave semantics.
- 2026-02-10: Added M6 conformance fixture (`advanced-m6-notation-baseline`) and expanded unit/integration/svg/conformance test coverage for advanced notation constructs.
- 2026-02-10: Added `docs/advanced-notation-policy.md` and refreshed notation/rendering/tips/README/AI state docs to reflect M6 support and fallback boundaries.
- 2026-02-10: Local/MCP Playwright browser launches were blocked by host MachPort/session constraints in this execution context; headless test gates passed and visual baseline updates remain environment-dependent.
- 2026-02-10: Added milestone-linked demo pipeline with tracked MusicXML demos (`happy-birthday`, `jingle-bells`), static build/serve scripts (`npm run demos:build`, `npm run demos:serve`), integration coverage (`tests/integration/demos.test.ts`), and README/AGENTS usage instructions.
- 2026-02-10: Replaced hand-authored demos with canonical LilyPond web fixtures (`01c`, `71g`), added `demos/lilypond/manifest.json` plus generated `demos/site/lilypond-roadmap.html`, and updated plan/todo/docs to make full LilyPond demo parity an explicit M7 end goal.
- 2026-02-10: Started M7 planning formalization; added `docs/m7-comprehensiveness-quality-plan.md`, split M7 into tracks M7A-M7D (comprehensiveness, quality rubric, layered eval framework, VexFlow upstream/release hardening), and updated M7 gates/checklists in plan/todo/ai-state.
- 2026-02-10: Implemented M7A corpus baseline: added LilyPond collated-suite sync script (`npm run corpus:lilypond:sync`), generated canonical corpus manifest (`fixtures/corpus/lilypond-collated-v2.25.json` with 30 categories / 156 fixtures), expanded seeded demos to 8 canonical fixtures, and refactored demo build pipeline + integration tests to validate roadmap seed/corpus consistency.
- 2026-02-10: Promoted M7A first conformance tranche by importing 8 seeded LilyPond fixtures into `fixtures/conformance/lilypond/` as active expected-pass cases and verified the expanded conformance workflow/report path remains green.
- 2026-02-10: Promoted M7A second conformance tranche by importing 21 additional LilyPond fixtures as active expected-pass cases, expanded conformance assertions for LilyPond category rollups, and kept full test + conformance report pipelines green.
- 2026-02-10: Added reusable `npm run corpus:lilypond:import` tooling to promote future LilyPond case batches into conformance fixtures from case IDs/source names with deterministic metadata generation.
- 2026-02-10: Fixed grace-note beaming regression (`B-002`) by guarding VexFlow `GraceNoteGroup.beamNotes()` and degrading to unbeamed grace notes with warning diagnostics; promoted `lilypond-24a-gracenotes` to active expected-pass coverage.
- 2026-02-10: Added `npm run conformance:lilypond:promote` bulk pipeline, imported all remaining LilyPond collated-suite fixtures, removed duplicate legacy seed IDs, and reached full corpus parity in conformance metadata (156/156 imported and active).
- 2026-02-10: Added representative real-world corpus manifest + importer (`npm run conformance:realworld:import`) and activated first 5 real-world fixtures (OpenScore Lieder + music21 corpus samples) with provenance/license metadata in conformance sidecars.
- 2026-02-10: Expanded M7A real-world coverage to 7 active fixtures by adding a lead-sheet sample (`realworld-music21-berlin-alexanders-ragtime`) and a large orchestral/choral excerpt (`realworld-music21-bach-bwv248-42-4`), added deterministic bucket-coverage integration gates (`tests/integration/realworld-corpus.test.ts`), and revalidated full test + conformance-report pipelines.
- 2026-02-10: Revalidated browser visual gates after M7A breadth expansion using repo-local Playwright binaries (`PLAYWRIGHT_BROWSERS_PATH=/Users/mo/git/musicxml/.playwright npm run test:visual -- --workers=4`), confirming all sentinel visual specs remain green.
- 2026-02-10: Added long-form stress fixture `realworld-music21-beethoven-op133-longform` to the real-world corpus/conformance set (now 8 active real-world fixtures; 176 active conformance fixtures total), increased conformance execution test timeout to 15s for expanded corpus runtime, and revalidated all headless + visual + demo-build gates.
- 2026-02-10: Reorganized planning artifacts under `/Users/mo/git/musicxml/docs/planning/`; split milestone docs into per-milestone files (`milestone-0.completed.md` .. `milestone-7D.md`), introduced `status.md` + `logs.md` ownership model, moved active/closed backlog into `todo.md` and `todo.completed.md`, and relocated feedback history to `/Users/mo/git/musicxml/docs/planning/feedback.md`.
- 2026-02-10: Completed M7A closeout by formalizing real-world complexity metadata (`complexity_level`, `part_count_hint`, `long_form`) with deterministic breadth gates, triaging `lilypond-23c-tuplet-display-nonstandard` as explicit malformed-source expected-fail policy, adding M7A conformance-threshold assertions (expected-pass `>=97%`, unexpected failures `<=1%`, LilyPond category floors `>=90%`), and promoting M7A status to completed in planning docs.
- 2026-02-10: Enforced milestone completion naming convention by renaming `docs/planning/milestone-7A.md` to `docs/planning/milestone-7A.completed.md`, updating all cross-doc references, and adding explicit completion-rename policy in `AGENTS.md` and `docs/planning/README.md`.
